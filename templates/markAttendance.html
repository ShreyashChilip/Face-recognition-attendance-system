  {% extends 'base.html' %}
  {% block title %}
  Mark Attendance
  {% endblock title %}
  {% block markattendance %}
  active
  {% endblock markattendance %}
  {% block body %}
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>

</style>
  <form method="POST" action="/showAttendance">
    <div class="container my-3">
      <h4>Mark Attendance</h4>
      <div class="form-group">
        <select class="custom-select" id="selectBatch" onchange="dayChange()">
          <option selected>Select Batch</option>
          <option value="Lecture">Lecture</option>
          <option value="1">IF1</option>
          <option value="2">IF2</option>
          <option value="3">IF3</option>
        </select>
        <div class="form-group">
          <p>Select the date for which to mark attendance: </p><input type="date" id="selectDay" name="selectedDay" onchange="dayChange()" />
          <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
        <div class="input-group mb-3">
          <select class="custom-select" id="selectLectures">
            <option>Select</option>
          </select>
        </div>
      </div>
      <video id="video" autoplay class="w-100"></video>
      <!-- <img src="{{ url_for('video_recog') }}" style="width: 90%;aspect-ratio:2;" id="vid_stream"> -->
      <br />
      <div class="btn-group-vertical" role="group" aria-label="Vertical radio toggle button group">
        <input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio1" style="display: none;" autocomplete="off"
          onchange="check(this.id)">
        <label class="btn btn-outline-danger" for="vbtn-radio1">Start Camera</label>
        <input type="radio" class="btn-check" name="vbtn-radio" id="vbtn-radio2" style="display: none;" autocomplete="off"
          checked onchange="check(this.id)">
        <label class="btn btn-outline-danger" for="vbtn-radio2">Stop Camera</label>
        <input type="button" class="btn btn-info" onclick="switchCamera()" value="Switch Camera">
      </div>
      <input type="button" class="btn btn-info" onclick="" value="Capture">
      <input type="button" class="btn btn-info" onclick="" value="Reset">
      <input type="submit" class="btn btn-primary" style="margin: 20px;" value="Show Attendance">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Roll No.</th>
            <th scope="col">Student Name</th>
            <th scope="col">Enrollment No.</th>
            <th scope="col">P/A</th>
          </tr>
        </thead>
        <tbody id="studentsRecord">
          {% for student in students %}
            <tr>
              <th scope="row">{{ loop.index }}</th>
              <td>{{ student.roll_no }}</td>
              <td>{{ student.name }}</td>
              <td>{{ student.enrollment_no }}</td>
              <!-- Add more columns if needed -->
              <td><input type="checkbox" name="student_checkbox" id ="{{ student.id }}" value="{{ student.id }}"></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
  </form>
  

  <script>
    let videoStream;
    let currentCamera = 'environment'; // 'environment' for rear, 'user' for front
    function check(r) {
      if (r === "vbtn-radio1") {
        startCamera();
      }
      if (r === "vbtn-radio2") {
        stopCamera();
      }
    }
    async function switchCamera() {
      if (document.getElementById('video').srcObject != null) {
        stopCamera();
        currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
        startCamera();
      }
    }
    async function startCamera() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentCamera } });
        document.getElementById('video').srcObject = videoStream;
        setInterval(captureFrame, 1000);
      } catch (error) {
        console.error('Error accessing camera:', error);
      }
    }
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
  // Capture frames
    function captureFrame() {
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(sendDataToFlask, 'image/png'); // Convert to Blob
    }

    function sendDataToFlask(blobData) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/process_video_frames', true);
      xhr.setRequestHeader('Content-Type', 'application/octet-stream');
      xhr.onload = function () {
        if (xhr.status === 200) {
          console.log('Data sent successfully');
          // var response = JSON.parse(xhr.responseText);
          // // Access the recognized students data
          // var recognizedStudents = response.recognized_students;
          // updateCheckboxes(recognizedStudents);
        } else {
          console.error('Error sending data to Flask:', xhr.statusText);
        }
      };
      xhr.onerror = function () {
        console.error('Network error while sending data to Flask');
      };
      xhr.send(blobData);
    }
    function stopCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        document.getElementById('video').srcObject = null;
        
              
          
      }
    }

  function updateCheckboxes(recognizedStudents)
  {
    recognizedStudents.forEach(function(student) {
          // Get the checkbox element with the corresponding ID
          checkbox = document.getElementById(student.id);
          checkbox.checked = true;
      });
  }
  const socket = io.connect();
var days = ["Invalid","Monday","Tuesday","Wednesday","Thursday","Friday","Invalid"]
function dayChange() {
    let selectDay = document.getElementById('selectDay');
    var date = new Date(selectDay.value)
    let day = days[date.getDay()];
    let errorMessageElement = document.getElementById('errorMessage');
    if(day=="Invalid")
    {
      errorMessageElement.innerText = "Invalid date selected.";
        errorMessageElement.style.display = 'block';
    }
    else{
      errorMessageElement.style.display = 'none';
    let selectBatch = document.getElementById('selectBatch');
    let batch = selectBatch.options[selectBatch.selectedIndex].value;

    console.log("Call 1 success");

    // Send the selected day and batch to the server using Socket.IO
    socket.emit('load_lectures', {
        selectedDay: day,
        selectedBatch: batch
    });
  }
}

// Listen for the response from the server
socket.on('lectures_loaded', function(slotsData) {
    // Update the select element with the new options
    updateSelectOptions(slotsData);
    console.log("Call 2 success");
});
function updateSelectOptions(slotsData) {
    let selectElement = $('#selectLectures');

    // Clear existing options
    selectElement.empty();
    selectElement.append($('<option>', {
            value: "Select",
            text: "Select"
        }));
    // Add new options for each slot
    slotsData.forEach(function (slot) {
        // Assuming each slot is a string, you may adjust this based on your data structure
        selectElement.append($('<option>', {
            value: slot,
            text: slot
        }));
    });
    console.log("Call 2 success");
}

  // Function to fetch lectures and update dropdown
  function fetchLectures(selectedDate) {
      // Make an AJAX request to the server to fetch lectures
      // Update the dropdown with the fetched data
  }

  function showAttendanceXHR() {
      var xhratt = new XMLHttpRequest();
      xhratt.open('GET', '/show_attendance', true);

      xhratt.onload = function () {
        if (xhratt.status === 200) {
          // Handle successful response, if needed
          console.log('Attendance data received successfully');
        } else {
          // Handle error response, if needed
          console.error('Error fetching attendance data:', xhratt.statusText);
        }
      };

      xhratt.onerror = function () {
        // Handle network errors, if needed
        console.error('Network error while fetching attendance data');
      };

      xhratt.send();
    }

  </script>
  <!-- jQuery first -->
  

  <!-- jQuery UI second -->
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

  <!-- Other scripts -->
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

  {% endblock body %}